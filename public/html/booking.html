<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UrbanRide Booking</title>
  <link rel="stylesheet" href="/css/booking.css" />
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="icon" href="/images/logo.png" type="image/png">
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBGvVzJu_zA6-ngh8zYuXKABa_CPS6p9B4&libraries=places"></script>
</head>
<body>
  <div class="container">
    <h1>Book Your Ride</h1>
    <form id="bookingForm">
      <input type="text" name="guestName" placeholder="Guest Name" required />
      <input type="number" name="passengers" placeholder="Passengers" required min="1" />
      <input type="email" name="email" placeholder="Email" required />
      <input type="tel" name="mobile" placeholder="Phone Number" required />
      <input type="text" name="address" placeholder="Address" required />
      <input type="text" id="pickup" name="pickup" placeholder="Pickup Location" required />
      <input type="text" id="dropoff" name="dropoff" placeholder="Dropoff Location" required />
      <input type="datetime-local" name="datetime" required />
      <select name="vehicle" required>
        <option value="">Select Vehicle Type</option>
        <option value="Sedan">Sedan</option>
        <option value="SUV">SUV</option>
        <option value="Tempo Traveller">Tempo Traveller</option>
      </select>
      <input type="text" name="member" placeholder="Associated Member" required />
      <div class="trip-type">
        <label><input type="radio" name="tripType" value="oneway" checked /> One Way</label>
        <label><input type="radio" name="tripType" value="roundtrip" /> Round Trip</label>
      </div>
      <button type="submit">Book Ride</button>
    </form>
    <div id="popup" class="popup-message"></div>
  </div>

  <script>
    let pickupCoords = null;
    let dropoffCoords = null;

    function initializeAutocomplete() {
      const pickupInput = document.getElementById('pickup');
      const dropoffInput = document.getElementById('dropoff');

      const pickupAutocomplete = new google.maps.places.Autocomplete(pickupInput);
      const dropoffAutocomplete = new google.maps.places.Autocomplete(dropoffInput);

      pickupAutocomplete.addListener('place_changed', () => {
        const place = pickupAutocomplete.getPlace();
        if (place.geometry) {
          pickupCoords = {
            lat: place.geometry.location.lat(),
            lng: place.geometry.location.lng()
          };
        }
      });

      dropoffAutocomplete.addListener('place_changed', () => {
        const place = dropoffAutocomplete.getPlace();
        if (place.geometry) {
          dropoffCoords = {
            lat: place.geometry.location.lat(),
            lng: place.geometry.location.lng()
          };
        }
      });
    }

    window.onload = initializeAutocomplete;

    function showPopupMessage(type, message) {
      const popup = document.getElementById('popup');
      popup.textContent = message;
      popup.className = 'popup-message ' + type;
      popup.style.display = 'block';
      setTimeout(() => {
        popup.style.display = 'none';
      }, 3000);
    }

    document.getElementById('bookingForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const form = e.target;

      if (!pickupCoords || !dropoffCoords) {
        showPopupMessage('error', '⚠️ Please select both pickup and dropoff locations.');
        return;
      }

      const tripType = document.querySelector('input[name="tripType"]:checked')?.value;

      const bookingData = {
        guest_name: form.guestName.value,
        passengers: parseInt(form.passengers.value),
        email: form.email.value,
        phone: form.mobile.value,
        address: form.address.value,
        trip_type: tripType,
        pickup: form.pickup.value,
        dropoff: form.dropoff.value,
        date_time: form.datetime.value,
        vehicle_type: form.vehicle.value,
        associated_member: form.member.value
      };

      try {
        const response = await fetch('https://urbanride-backend.up.railway.app/api/bookings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bookingData)
        });

        const result = await response.json();

        if (response.ok && result.booking_id) {
          showPopupMessage('success', `✅ Booking successful! ID: ${result.booking_id} \nRedirecting...`);
          form.reset();
          setTimeout(() => {
            window.location.href = `/html/confirmation.html?booking_id=${result.booking_id}`;
          }, 3000);
        } else {
          showPopupMessage('error', result.message || '❌ Something went wrong.');
        }
      } catch (err) {
        console.error(err);
        showPopupMessage('error', '⚠️ Could not send request. Try again.');
      }
    });
  </script>
</body>
</html>

